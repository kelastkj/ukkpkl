<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pengujian - Dashboard Guru</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="config.js"></script>
  <style>
    :root{ color-scheme: light; }
    body{ background: linear-gradient(180deg, rgba(240,253,250,1) 0%, rgba(239,246,255,1) 100%); }
    .card{ background:white; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,.06); padding:16px; }
    .hidden{ display:none; }
    .resp-table{ width:100%; border-collapse:collapse; }
    .resp-th, .resp-td{ border-bottom:1px solid #e5e7eb; padding:8px 12px; vertical-align:top; }
    @media (max-width: 640px){
      .resp-table thead{ display:none; }
      .resp-table tr{ display:block; border:none; border-radius:12px; margin:12px 0; overflow:hidden; background:#fff; box-shadow:0 10px 26px rgba(2,6,23,.06); position:relative; }
      .resp-table tr::before{ content:""; position:absolute; left:0; top:0; bottom:0; width:4px; background: var(--accent, #cbd5e1); }
      .resp-table tr[data-category="pkl"]{ --accent:#10b981; }
      .resp-table tr[data-category="ukk"]{ --accent:#3b82f6; }
      .resp-table td.resp-td{ display:grid; grid-template-columns: 40% 60%; gap:8px; border-bottom:1px solid #f1f5f9; }
      .resp-table td.resp-td:last-child{ border-bottom:none; }
      .resp-table td.resp-td::before{ content: attr(data-label); font-weight:600; color:#475569; }
    }
  /* Make mobile menu fixed under the sticky header on small screens */
  #mobileMenu{ position:fixed; left:0; right:0; top:56px; z-index:40; max-height:calc(100vh - 56px); overflow:auto; box-shadow:0 8px 30px rgba(2,6,23,.08); }
  @media (min-width: 768px){ #mobileMenu{ position:static; max-height:none; overflow:visible; box-shadow:none; } }
    .badge-cat{ display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px; font-weight:600; border:1px solid transparent; }
    .badge-pkl{ background:#ecfdf5; color:#065f46; border-color:#a7f3d0; }
    .badge-ukk{ background:#eff6ff; color:#1e3a8a; border-color:#bfdbfe; }
    .tabs{ display:flex; align-items:center; gap:8px; }
    .tab-btn{ appearance:none; border:1px solid #dbe3ef; background:#f8fafc; color:#334155; font-weight:600; padding:6px 12px; border-radius:999px; cursor:pointer; }
    .tab-btn[aria-selected="true"], .tab-btn.active{ background:#ffffff; color:#0f172a; border-color:#cbd5e1; box-shadow:0 2px 6px rgba(15,23,42,.06); }
    .tab-panel{ display:none; }
    .tab-panel.active{ display:block; }
    /* Toasts */
    .toast-container{ position:fixed; right:1rem; bottom:1rem; display:flex; flex-direction:column; gap:0.5rem; z-index:60; }
    .toast{ min-width:220px; max-width:360px; display:flex; gap:0.75rem; align-items:center; background:white; border-radius:12px; padding:10px 12px; box-shadow:0 10px 25px rgba(2,6,23,.12); border:1px solid #e6eef6; }
    .toast.ok{ border-color:#d1fae5; background:linear-gradient(180deg,#ecfdf5,#ffffff); }
    .toast.err{ border-color:#fee2e2; background:linear-gradient(180deg,#fff1f2,#ffffff); }
    .toast .msg{ flex:1; font-size:13px; color:#0f172a; }
    .toast .close{ background:transparent; border:0; color:#475569; cursor:pointer; padding:6px; border-radius:8px; }
    .toast .icon{ width:20px; height:20px; flex:0 0 20px; }
    /* Loading overlay (match dashboard) */
    #loading{ position:fixed; inset:0; z-index:40; background:rgba(0,0,0,0.12); backdrop-filter: blur(4px); display:flex; align-items:center; justify-content:center; }
    #loading.hidden{ display:none; }
    #loading > .rounded-xl{ padding:12px 14px; display:flex; gap:10px; align-items:center; }
  </style>
</head>
<body class="min-h-screen flex flex-col text-slate-800">
  <nav class="sticky top-0 z-30 border-b bg-white/90 backdrop-blur">
    <div class="mx-auto max-w-6xl px-4">
      <div class="flex h-14 items-center justify-between gap-3">
        <a href="index.html" class="flex items-center gap-2 shrink-0">
          <img src="logo.png" alt="Logo TKJ SMKN 1 Telagasari" class="h-8 w-8 rounded-lg" />
          <div class="leading-tight">
            <div class="font-bold tracking-tight">SI PKL & UKK Industri</div>
            <div class="text-[11px] text-slate-500">Pengujian</div>
          </div>
        </a>
        <div class="flex items-center gap-3">
          <ul class="hidden md:flex items-center gap-1 text-sm">
            <li><a href="dashboard.html" class="px-3 py-2 rounded-lg hover:bg-slate-100 flex items-center gap-2"><i data-lucide="layout-dashboard" class="w-4 h-4"></i>Dashboard</a></li>
            <li><a href="bimbingan.html" class="px-3 py-2 rounded-lg hover:bg-slate-100 flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i>Bimbingan</a></li>
            <li><a href="pengujian.html" class="px-3 py-2 rounded-lg bg-emerald-600 text-white flex items-center gap-2"><i data-lucide="clipboard-check" class="w-4 h-4"></i>Pengujian</a></li>
            <li><a href="sertifikat.html" class="px-3 py-2 rounded-lg hover:bg-slate-100 flex items-center gap-2"><i data-lucide="award" class="w-4 h-4"></i>Sertifikat</a></li>
          </ul>
          <button id="burgerBtn" class="md:hidden inline-flex items-center justify-center h-9 w-9 rounded-lg border hover:bg-slate-100" aria-label="Menu">
            <i data-lucide="menu" id="burgerIcon" class="w-5 h-5"></i>
            <i data-lucide="x" id="closeIcon" class="w-5 h-5 hidden"></i>
          </button>
          <div class="relative">
            <button id="profileToggle" type="button" class="flex items-center gap-2 rounded-full border border-slate-200 bg-white px-2 py-1 text-sm font-medium text-slate-600 shadow-sm hover:border-emerald-300 focus:outline-none focus:ring-2 focus:ring-emerald-200" aria-haspopup="true" aria-expanded="false">
              <span id="profileInitial" class="flex h-8 w-8 items-center justify-center rounded-full bg-emerald-600 text-white text-sm font-semibold">U</span>
              <span class="hidden sm:flex flex-col items-start leading-tight">
                <span id="profileName" class="text-sm font-medium text-slate-700">Pengguna</span>
                <span id="profileRole" class="text-xs text-slate-500 uppercase tracking-wide">ROLE</span>
              </span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.584l3.71-3.353a.75.75 0 111.04 1.08l-4.24 3.83a.75.75 0 01-1.04 0l-4.24-3.83a.75.75 0 01.02-1.1z" clip-rule="evenodd" />
              </svg>
            </button>
            <div id="profileMenu" class="absolute right-0 mt-2 w-52 origin-top-right rounded-xl border border-slate-200 bg-white shadow-lg ring-1 ring-black/5 hidden">
              <div class="border-b border-slate-100 px-4 py-3">
                <div id="profileFullName" class="text-sm font-semibold text-slate-800">Pengguna</div>
                <div id="profileFullRole" class="text-xs font-medium uppercase tracking-wide text-slate-500">ROLE</div>
              </div>
              <button id="logout" class="flex w-full items-center gap-2 px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6A2.25 2.25 0 005.25 5.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
                </svg>
                Keluar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div id="mobileMenu" class="md:hidden hidden border-t bg-white">
    <div class="mx-auto max-w-6xl px-4 py-2">
      <ul class="flex flex-col gap-1 text-sm">
        <li><a href="dashboard.html" class="block px-3 py-2 rounded-lg hover:bg-slate-100 flex items-center gap-2"><i data-lucide="layout-dashboard" class="w-5 h-5"></i>Dashboard</a></li>
        <li><a href="bimbingan.html" class="block px-3 py-2 rounded-lg hover:bg-slate-100 flex items-center gap-2"><i data-lucide="users" class="w-5 h-5"></i>Bimbingan</a></li>
        <li><a href="pengujian.html" class="block px-3 py-2 rounded-lg bg-emerald-600 text-white flex items-center gap-2"><i data-lucide="clipboard-check" class="w-5 h-5"></i>Pengujian</a></li>
        <li><a href="sertifikat.html" class="block px-3 py-2 rounded-lg hover:bg-slate-100 flex items-center gap-2"><i data-lucide="award" class="w-5 h-5"></i>Sertifikat</a></li>
      </ul>
    </div>
  </div>

  <div id="content" class="flex-1">
  <main class="max-w-6xl mx-auto px-4 py-4 space-y-4">
    <header>
      <h1 class="text-xl font-bold tracking-tight">Pengujian</h1>
      <p class="text-sm text-slate-600">Unggahan dari siswa yang Anda uji.</p>
    </header>

    <section class="card p-5 space-y-4">
      <div class="flex items-center justify-between gap-3">
        <div class="tabs" role="tablist" aria-label="Kategori unggahan pengujian">
          <button id="tab-btn-pj-pkl" class="tab-btn" role="tab" aria-selected="true" aria-controls="panel-pj-pkl">PKL <span id="tab-count-pj-pkl" class="ml-1 text-xs font-semibold text-slate-500">(0)</span></button>
          <button id="tab-btn-pj-ukk" class="tab-btn" role="tab" aria-selected="false" aria-controls="panel-pj-ukk">UKK <span id="tab-count-pj-ukk" class="ml-1 text-xs font-semibold text-slate-500">(0)</span></button>
        </div>
      </div>
      <div id="panel-pj-pkl" class="tab-panel active" role="tabpanel" aria-labelledby="tab-btn-pj-pkl">
        <div class="table-wrap overflow-auto rounded-lg border border-slate-200">
          <table class="resp-table text-sm">
            <thead class="bg-slate-50">
              <tr>
                <th class="resp-th text-left font-medium text-slate-600">Waktu</th>
                <th class="resp-th text-left font-medium text-slate-600">Siswa</th>
                <th class="resp-th text-left font-medium text-slate-600">Kelas</th>
                <th class="resp-th text-left font-medium text-slate-600">Mitra</th>
                <th class="resp-th text-left font-medium text-slate-600">Kategori</th>
                <th class="resp-th text-left font-medium text-slate-600">Nama File</th>
                <th class="resp-th text-left font-medium text-slate-600">Nilai</th>
                <th class="resp-th text-left font-medium text-slate-600">Aksi</th>
              </tr>
            </thead>
            <tbody id="guru-pj-tbody-pkl"><tr><td colspan="8" class="px-3 py-3 text-slate-500">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div>
      <div id="panel-pj-ukk" class="tab-panel" role="tabpanel" aria-labelledby="tab-btn-pj-ukk">
        <div class="table-wrap overflow-auto rounded-lg border border-slate-200">
          <table class="resp-table text-sm">
            <thead class="bg-slate-50">
              <tr>
                <th class="resp-th text-left font-medium text-slate-600">Waktu</th>
                <th class="resp-th text-left font-medium text-slate-600">Siswa</th>
                <th class="resp-th text-left font-medium text-slate-600">Kelas</th>
                <th class="resp-th text-left font-medium text-slate-600">Mitra</th>
                <th class="resp-th text-left font-medium text-slate-600">Kategori</th>
                <th class="resp-th text-left font-medium text-slate-600">Nama File</th>
                <th class="resp-th text-left font-medium text-slate-600">Aksi</th>
              </tr>
            </thead>
            <tbody id="guru-pj-tbody-ukk"><tr><td colspan="7" class="px-3 py-3 text-slate-500">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>
  </div>

  <iframe name="upload_iframe" id="upload_iframe" class="hidden" title="upload" loading="lazy"></iframe>
  <div id="loading" class="hidden fixed inset-0 z-40 bg-black/20 backdrop-blur-sm flex items-center justify-center">
    <div class="rounded-xl bg-white shadow p-4 flex items-center gap-3">
      <svg class="animate-spin h-5 w-5 text-emerald-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
      <div class="text-sm text-slate-700">Memproses...</div>
    </div>
  </div>
  <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <div id="confirmModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative w-full max-w-sm mx-4 rounded-xl bg-white shadow-lg">
      <div class="border-b px-4 py-3 flex items-center gap-2">
        <i data-lucide="alert-triangle" class="w-5 h-5 text-red-600"></i>
        <div class="font-semibold">Konfirmasi</div>
      </div>
      <div class="px-4 py-3 text-sm text-slate-700">Apakah Anda yakin ingin menghapus file ini?</div>
      <div class="px-4 py-3 flex items-center justify-end gap-2 border-t">
        <button id="modalCancel" class="px-3 py-1.5 rounded-lg border text-slate-700 hover:bg-slate-50">Batal</button>
        <button id="modalConfirm" class="px-3 py-1.5 rounded-lg bg-red-600 text-white hover:bg-red-700">Hapus</button>
      </div>
    </div>
  </div>

  <!-- Score modal -->
  <div id="scoreModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative w-full max-w-lg mx-4 rounded-xl bg-white shadow-lg">
      <div class="border-b px-4 py-3 flex items-center gap-2">
        <i data-lucide="award" class="w-5 h-5 text-amber-600"></i>
        <div class="font-semibold">Lembar Penilaian Presentasi</div>
      </div>
      <div class="px-4 py-3 text-sm text-slate-700 space-y-3">
        <div class="text-sm font-medium">Siswa: <span id="scoreName" class="font-semibold">-</span></div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <label class="block"><div class="text-xs text-slate-500">Struktur Laporan</div><select id="score-struktur" class="w-full rounded border px-2 py-1"><option value="4">Sangat Baik</option><option value="3">Baik</option><option value="2">Cukup</option><option value="1">Kurang</option></select></label>
          <label class="block"><div class="text-xs text-slate-500">Penyampaian Materi</div><select id="score-penyampaian" class="w-full rounded border px-2 py-1"><option value="4">Sangat Baik</option><option value="3">Baik</option><option value="2">Cukup</option><option value="1">Kurang</option></select></label>
          <label class="block"><div class="text-xs text-slate-500">Penguasaan Materi</div><select id="score-penguasaan" class="w-full rounded border px-2 py-1"><option value="4">Sangat Baik</option><option value="3">Baik</option><option value="2">Cukup</option><option value="1">Kurang</option></select></label>
          <label class="block"><div class="text-xs text-slate-500">Media Presentasi</div><select id="score-media" class="w-full rounded border px-2 py-1"><option value="4">Sangat Baik</option><option value="3">Baik</option><option value="2">Cukup</option><option value="1">Kurang</option></select></label>
          <label class="block col-span-full"><div class="text-xs text-slate-500">Sikap dan Komunikasi</div><select id="score-sikap" class="w-full rounded border px-2 py-1"><option value="4">Sangat Baik</option><option value="3">Baik</option><option value="2">Cukup</option><option value="1">Kurang</option></select></label>
        </div>
        <div class="pt-2">
          <div class="text-sm">Rata-rata (1-4): <span id="score-average" class="font-semibold">-</span></div>
          <div class="text-sm">Nilai akhir (0-100): <span id="score-final" class="font-semibold">-</span></div>
        </div>
      </div>
      <div class="px-4 py-3 flex items-center justify-end gap-2 border-t">
        <button id="scoreCancel" class="px-3 py-1.5 rounded-lg border text-slate-700 hover:bg-slate-50">Batal</button>
        <button id="scoreSave" class="px-3 py-1.5 rounded-lg bg-amber-600 text-white hover:bg-amber-700">Simpan</button>
      </div>
    </div>
  </div>

  <script>
  const BASE = (window.APP_CONFIG||{}).BASE_URL;
  let pendingDeleteId = null, deleteNotified = false;
  let isDeleting = false;
  let nilaiMapGlobal = new Map();
  // In-memory authoritative profile fetched from server; use cached localStorage for fast render
  let CURRENT_PROFILE = null;
  function getProfile(){ try{ return CURRENT_PROFILE || JSON.parse(localStorage.getItem('auth_profile')||'{}'); }catch(e){ return {}; } }
  async function fetchServerProfile(token){ if(!token) return null; try{ const resp = await jsonp(`${BASE}?dataset=auth&route=check&token=${encodeURIComponent(token)}`); if(resp && resp.ok && resp.profile) return resp.profile; return null; }catch(e){ return null; } }

    // Lightweight toast helper (matches dashboard style)
    (function(){
      window._toast = function(type, text, opts){
        const root = document.getElementById('toastContainer'); if(!root) return;
        const id = 't_' + Math.random().toString(36).slice(2);
        const div = document.createElement('div'); div.className = 'toast ' + (type==='ok'?'ok':(type==='err'?'err':'')); div.id = id;
        const icon = document.createElement('span'); icon.className = 'icon'; icon.textContent = type==='ok' ? '✅' : (type==='err' ? '⚠️' : 'ℹ️');
        const msg = document.createElement('div'); msg.className = 'msg'; msg.textContent = text || '';
        const close = document.createElement('button'); close.className='close'; close.setAttribute('aria-label','Tutup'); close.innerHTML='&times;';
        close.addEventListener('click', ()=>{ try{ div.remove(); }catch(_){} });
        div.appendChild(icon); div.appendChild(msg); div.appendChild(close);
        root.appendChild(div);
        const ttl = (opts && opts.ttl) || 5000;
        const timer = setTimeout(()=>{ try{ div.remove(); }catch(_){} }, ttl);
        return { id, close: ()=>{ clearTimeout(timer); try{ div.remove(); }catch(_){} } };
      };
    })();
    function toast(type, text, opts){ if(window._toast) return window._toast(type, text, opts); }

    function showLoading(v){ const el = document.getElementById('loading'); if(!el) return; if(v) el.classList.remove('hidden'); else el.classList.add('hidden'); }
    function setAllDeleteButtonsDisabled(dis){ document.querySelectorAll('button[data-del]').forEach(b=>{ b.disabled = !!dis; b.classList.toggle('opacity-60', !!dis); b.classList.toggle('cursor-not-allowed', !!dis); }); }

    // Listen for postMessage from Apps Script iframe for delete confirmation
    window.addEventListener('message', (ev)=>{
      if(!ev || !ev.data) return;
      console.log('postMessage received:', ev.data, 'origin:', ev.origin);
      if(ev.data.type === 'delete'){
        const ok = !!ev.data.ok; deleteNotified = true;
        toast(ok?'ok':'err', ev.data.message || (ok?'Berhasil dihapus':'Gagal menghapus'));
        loadPengujian(); showLoading(false); setAllDeleteButtonsDisabled(false);
      }
      // handle save_nilai responses from backend
      if(ev.data.type === 'save_nilai'){
        const ok = !!ev.data.ok;
        // prefer explicit message, fallback generic
        toast(ok ? 'ok' : 'err', ev.data.message || (ok ? 'Nilai tersimpan' : 'Gagal menyimpan nilai'));
        // if backend included username/data, update local map and DOM so UI reflects saved nilai immediately
        try{
          const d = ev.data.data || null;
          const username = (ev.data.username || (d && d.username) || '') + '';
          if(username){
            if(d) nilaiMapGlobal.set(String(username), d);
            // find any assess button for this username and mark as saved
            const btn = document.querySelector(`button[data-username="${username}"]`);
            if(btn){ btn.setAttribute('data-has','1'); btn.classList.add('bg-emerald-100','text-emerald-700'); }
            // update Nilai cell in the same row (if present)
            try{
              const tr = btn ? btn.closest('tr') : null;
              if(tr){ const tdNilai = tr.querySelector('td[data-label="Nilai"]'); if(tdNilai) tdNilai.textContent = (d && d.total) ? String(d.total) : ''; }
            }catch(e){}
          }
        }catch(e){ /* ignore optimistic update errors */ }
        // refresh data to ensure consistency
        loadPengujian(); showLoading(false);
      }
    });

    // Polling fallback: after submitting a score, poll the nilaipresentasi dataset to confirm save
    async function pollSaveConfirmation(username, expectedTotal){
      if(!username) return false;
      const token = localStorage.getItem('auth_token');
      const start = Date.now();
      try{
        while(Date.now() - start < 20000){
          await sleep(1200);
          try{
            const resp = await jsonp(`${BASE}?dataset=nilaipresentasi&token=${encodeURIComponent(token)}`);
            if(resp && resp.ok && Array.isArray(resp.data)){
              const found = resp.data.find(x => String(x.username) === String(username));
              if(found){
                // optional: if expectedTotal provided, match it
                if(!expectedTotal || String(found.total) === String(expectedTotal)){
                  // update local map and UI
                  nilaiMapGlobal.set(String(username), found);
                  const btn = document.querySelector(`button[data-username="${username}"]`);
                  if(btn){ btn.setAttribute('data-has','1'); btn.classList.add('bg-emerald-100','text-emerald-700'); const tr = btn.closest('tr'); if(tr){ const tdNilai = tr.querySelector('td[data-label="Nilai"]'); if(tdNilai) tdNilai.textContent = String(found.total || ''); } }
                  toast('ok', 'Nilai tersimpan');
                  loadPengujian(); showLoading(false);
                  return true;
                }
              }
            }
          }catch(_){ }
        }
      }catch(_){ }
      // timeout
      toast('err', 'Tidak mendapat konfirmasi penyimpanan nilai (timeout)');
      showLoading(false);
      return false;
    }

    function requireGuru(){
      const token = localStorage.getItem('auth_token');
      if(!token){ location.href = 'login.html?to=' + encodeURIComponent('pengujian.html'); return null; }
      return token; // role check will happen after background validation
    }

    function jsonp(url){
      return new Promise((resolve, reject)=>{
        const cb = 'cb_' + Math.random().toString(36).slice(2);
        const sep = url.includes('?') ? '&' : '?';
        window[cb] = (data)=>{ resolve(data); cleanup(); };
        const s = document.createElement('script'); s.src = url + sep + 'callback=' + cb; s.onerror = ()=>{ reject(new Error('Gagal memuat JSONP')); cleanup(); };
        document.body.appendChild(s);
        function cleanup(){ try{ delete window[cb]; s.remove(); }catch(_){} }
      });
    }

    function setupProfileMenu(){
      const toggle = document.getElementById('profileToggle');
      const menu = document.getElementById('profileMenu');
      const logoutBtn = document.getElementById('logout');
      if(logoutBtn){ logoutBtn.addEventListener('click', ()=>{ localStorage.removeItem('auth_token'); localStorage.removeItem('auth_profile'); location.href='login.html'; }); }
      if(!toggle || !menu) return;
      const closeMenu = ()=>{ menu.classList.add('hidden'); toggle.setAttribute('aria-expanded','false'); };
      const openMenu = ()=>{ menu.classList.remove('hidden'); toggle.setAttribute('aria-expanded','true'); };
      toggle.addEventListener('click',(e)=>{ e.stopPropagation(); if(menu.classList.contains('hidden')) openMenu(); else closeMenu(); });
      document.addEventListener('click',(e)=>{ if(menu.classList.contains('hidden')) return; if(toggle.contains(e.target) || menu.contains(e.target)) return; closeMenu(); });
      document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeMenu(); });
    }

    function greet(){
      const prof = getProfile();
      const nameRaw = (prof.nama || prof.username || 'Pengguna').trim();
      const name = nameRaw || 'Pengguna';
      const parts = name.split(/\s+/).filter(Boolean);
      const shortName = parts.slice(0,2).join(' ') || name;
      const role = ((prof.role||'')||'').toString().trim().toUpperCase() || 'USER';
      const nameEl = document.getElementById('profileName'); const roleEl = document.getElementById('profileRole');
      const fullNameEl = document.getElementById('profileFullName'); const fullRoleEl = document.getElementById('profileFullRole');
      const initialEl = document.getElementById('profileInitial');
      if(nameEl) nameEl.textContent = shortName; if(roleEl) roleEl.textContent = role;
      if(fullNameEl) fullNameEl.textContent = name; if(fullRoleEl) fullRoleEl.textContent = role;
      if(initialEl) initialEl.textContent = (shortName[0]||'U').toUpperCase();
      document.querySelectorAll('[data-guru="1"]').forEach(el=> el.classList.remove('hidden'));
    }

    function setupBurger(){
      const burgerBtn = document.getElementById('burgerBtn');
      const burgerIcon = document.getElementById('burgerIcon');
      const closeIcon = document.getElementById('closeIcon');
      const mobile = document.getElementById('mobileMenu');
      if(!burgerBtn || !mobile) return;
      burgerBtn.setAttribute('aria-controls', 'mobileMenu');
      burgerBtn.setAttribute('aria-expanded', 'false');
      const open = ()=>{
        mobile.classList.remove('hidden'); burgerBtn.setAttribute('aria-expanded','true'); if(burgerIcon) burgerIcon.classList.add('hidden'); if(closeIcon) closeIcon.classList.remove('hidden'); document.body.classList.add('overflow-hidden');
      };
      const close = ()=>{
        mobile.classList.add('hidden'); burgerBtn.setAttribute('aria-expanded','false'); if(burgerIcon) burgerIcon.classList.remove('hidden'); if(closeIcon) closeIcon.classList.add('hidden'); document.body.classList.remove('overflow-hidden');
      };
      burgerBtn.addEventListener('click', (e)=>{ 
        e.stopPropagation(); 
        const wasHidden = mobile.classList.contains('hidden');
        if(wasHidden) open(); else close();
        if(wasHidden){ try{ mobile.scrollIntoView({ behavior: 'smooth', block: 'start' }); mobile.setAttribute('tabindex','-1'); mobile.focus({preventScroll:true}); }catch(_){ try{ mobile.scrollIntoView(); }catch(_){} } }
      });
      document.addEventListener('click', (ev)=>{ if(mobile.classList.contains('hidden')) return; if(burgerBtn.contains(ev.target) || mobile.contains(ev.target)) return; close(); });
      document.addEventListener('keydown', (ev)=>{ if(ev.key === 'Escape') close(); });
    }

    function renderGuruRows(tbodyId, rows, nilaiMap){
      const tb = document.getElementById(tbodyId); if(!tb) return; tb.innerHTML='';
  if(!rows || rows.length===0){ const colspan = tbodyId==='guru-pj-tbody-pkl' ? 8 : 7; tb.innerHTML = `<tr><td colspan="${colspan}" class="px-3 py-3 text-slate-500 text-center">Belum ada data</td></tr>`; return; }
      rows.forEach(r=>{
        const tr = document.createElement('tr'); tr.setAttribute('data-category', (r.category||'').toLowerCase());
        const t = (r.timestamp && String(r.timestamp).split('GMT')[0]) || r.timestamp || '';
        const isPKL = ((r.category||'').toLowerCase() === 'pkl');
        const existingNilai = (nilaiMap && r.username) ? nilaiMap.get(r.username) : null;
        // Build row cells dynamically so UKK rows don't get an extra Nilai cell
        let cells = '';
        cells += `<td class="resp-td px-3 py-2 whitespace-nowrap" data-label="Waktu">${t}</td>`;
        cells += `<td class="resp-td px-3 py-2" data-label="Siswa">${r.nama||''}</td>`;
        cells += `<td class="resp-td px-3 py-2" data-label="Kelas">${r.kelas||''}</td>`;
        cells += `<td class="resp-td px-3 py-2" data-label="Mitra">${r.mitra||''}</td>`;
        cells += `<td class="resp-td px-3 py-2" data-label="Kategori"><span class="badge-cat ${isPKL?'badge-pkl':'badge-ukk'}">${r.category||''}</span></td>`;
        cells += `<td class="resp-td px-3 py-2" data-label="Nama File">${r.fileName||''}</td>`;
        if(isPKL){
          cells += `<td class="resp-td px-3 py-2" data-label="Nilai">${ existingNilai ? (existingNilai.total || '') : '' }</td>`;
        }
        // action cell
        cells += `<td class="resp-td px-3 py-2 whitespace-nowrap" data-label="Aksi">`;
        cells += `<div class="flex items-center gap-3">`;
        cells += `<a class="inline-flex items-center justify-center text-slate-600 hover:text-blue-600" target="_blank" href="https://drive.google.com/file/d/${r.fileId}/view" aria-label="Buka file"><i data-lucide="eye" class="w-4 h-4"></i><span class="sr-only">Buka</span></a>`;
        cells += `<button data-del="${r.fileId}" class="inline-flex items-center justify-center text-slate-600 hover:text-red-600" type="button" aria-label="Hapus file"><i data-lucide="trash-2" class="w-4 h-4"></i><span class="sr-only">Hapus</span></button>`;
        if(isPKL){
          cells += `<button data-assess="${r.nama}" data-username="${r.username||''}" data-has="${existingNilai?1:0}" class="inline-flex items-center justify-center ${existingNilai?'bg-emerald-100 text-emerald-700':''} px-2 py-1 rounded-md" type="button" aria-label="Penilaian"><i data-lucide="star" class="w-4 h-4"></i><span class="sr-only">Penilaian</span></button>`;
        }
        cells += `</div>`;
        cells += `</td>`;
        tr.innerHTML = cells;
        tb.appendChild(tr);
      });
      tb.querySelectorAll('button[data-del]').forEach(btn=>{ btn.addEventListener('click', ()=> openConfirm(btn.getAttribute('data-del'))); });
      tb.querySelectorAll('button[data-assess]').forEach(btn=>{ btn.addEventListener('click', (ev)=>{
        const b = ev.currentTarget; const uname = b.getAttribute('data-username'); const nama = b.getAttribute('data-assess'); const has = b.getAttribute('data-has');
        openScoreModal(uname, nama, has);
      }); });
      if(window.lucide && typeof window.lucide.createIcons === 'function'){ window.lucide.createIcons(); }
    }

    function setTabCounts(pkl, ukk){ const c1 = document.getElementById('tab-count-pj-pkl'); const c2 = document.getElementById('tab-count-pj-ukk'); if(c1) c1.textContent = `(${pkl||0})`; if(c2) c2.textContent = `(${ukk||0})`; }
    function setupTabs(){
      const btnPKL = document.getElementById('tab-btn-pj-pkl'); const btnUKK = document.getElementById('tab-btn-pj-ukk');
      const panelPKL = document.getElementById('panel-pj-pkl'); const panelUKK = document.getElementById('panel-pj-ukk');
      if(!btnPKL || !btnUKK || !panelPKL || !panelUKK) return;
      const activate = (which)=>{ const showPKL = which === 'pkl'; btnPKL.setAttribute('aria-selected', showPKL ? 'true' : 'false'); btnUKK.setAttribute('aria-selected', showPKL ? 'false' : 'true'); panelPKL.classList.toggle('active', showPKL); panelUKK.classList.toggle('active', !showPKL); };
      btnPKL.addEventListener('click', ()=> activate('pkl')); btnUKK.addEventListener('click', ()=> activate('ukk')); activate('pkl');
    }

  function getGuruName(){ const prof = getProfile(); return (prof.nama || prof.username || '').trim(); }

    async function loadPengujian(){
      try{
        const token = localStorage.getItem('auth_token'); const guruName = getGuruName();
        const pj = await jsonp(`${BASE}?dataset=penguji&penguji=${encodeURIComponent(guruName)}`);
        const pjNames = new Set((pj && pj.ok && Array.isArray(pj.data) ? pj.data : []).map(r => r.siswa).filter(Boolean));
        const uploadsResp = await jsonp(`${BASE}?dataset=uploads&route=students&token=${encodeURIComponent(token)}`);
        if(!uploadsResp.ok) throw new Error(uploadsResp.error||'Gagal memuat');
        const rows = Array.isArray(uploadsResp.data) ? uploadsResp.data : [];
        // load saved presentation scores and build map keyed by username
        try{
            const nilaiResp = await jsonp(`${BASE}?dataset=nilaipresentasi&token=${encodeURIComponent(token)}`);
          nilaiMapGlobal = new Map();
          if(nilaiResp && nilaiResp.ok && Array.isArray(nilaiResp.data)){
            nilaiResp.data.forEach(n => { if(n && n.username) nilaiMapGlobal.set(String(n.username), n); });
          }
        }catch(err){ /* ignore nilai load errors, proceed with empty map */ nilaiMapGlobal = new Map(); }
        const rowsPJ = rows.filter(r => pjNames.has(r.nama));
        const pjPKL = rowsPJ.filter(r => (r.category||'').toLowerCase()==='pkl');
        const pjUKK = rowsPJ.filter(r => (r.category||'').toLowerCase()==='ukk');
        renderGuruRows('guru-pj-tbody-pkl', pjPKL, nilaiMapGlobal);
        renderGuruRows('guru-pj-tbody-ukk', pjUKK, nilaiMapGlobal);
        setTabCounts(pjPKL.length, pjUKK.length);
  }catch(e){ ['guru-pj-tbody-pkl','guru-pj-tbody-ukk'].forEach(id => { const el=document.getElementById(id); if(el){ const colspan = id==='guru-pj-tbody-pkl' ? 8 : 7; el.innerHTML = `<tr><td colspan="${colspan}" class="px-3 py-3 text-red-600 text-center">${e.message}</td></tr>`; } }); }
    }

    function openConfirm(fileId){ if(!fileId) return; pendingDeleteId=fileId; const m=document.getElementById('confirmModal'); if(m) m.classList.remove('hidden'); if(window.lucide){ try{ lucide.createIcons(); }catch(e){} } }
    function closeConfirm(){ const m=document.getElementById('confirmModal'); if(m) m.classList.add('hidden'); pendingDeleteId=null; }
    function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
    function performDelete(){
      if(!pendingDeleteId) return; const fileId=pendingDeleteId; closeConfirm(); const token=localStorage.getItem('auth_token'); const form=document.createElement('form'); form.method='post'; form.target='upload_iframe'; form.action=BASE; const add=(n,v)=>{ const i=document.createElement('input'); i.type='hidden'; i.name=n; i.value=v; form.appendChild(i); };
      add('action','delete'); add('token', token); add('fileId', fileId); document.body.appendChild(form);
      // UI lock + loading
      showLoading(true);
      setAllDeleteButtonsDisabled(true);
      form.submit(); form.remove(); deleteNotified=false; pollDeleteConfirmation(fileId);
    }
    async function pollDeleteConfirmation(fileId){
      try{
        const token = localStorage.getItem('auth_token');
        const start = Date.now();
        while(Date.now() - start < 25000){
          await sleep(1500);
          if(deleteNotified) return;
          const data = await jsonp(`${BASE}?dataset=uploads&route=students&token=${encodeURIComponent(token)}`);
          if(data && data.ok && Array.isArray(data.data)){
            const exists = data.data.some(r => String(r.fileId) === String(fileId));
            if(!exists){
              deleteNotified = true;
              toast('ok', 'File dan data berhasil dihapus.');
              loadPengujian();
              showLoading(false);
              isDeleting = false;
              setAllDeleteButtonsDisabled(false);
              return;
            }
          }
        }
      }catch(_){ /* ignore */ }
      finally{
        if(!deleteNotified){ showLoading(false); isDeleting = false; setAllDeleteButtonsDisabled(false); }
      }
    }

    function init(){
      setupProfileMenu(); setupBurger();
      const token = requireGuru(); if(!token) return;
      // Render minimal UI from cached profile (no teacher data yet)
      try{ const cached = JSON.parse(localStorage.getItem('auth_profile')||'null'); if(cached) CURRENT_PROFILE = cached; }catch(e){ CURRENT_PROFILE = null; }
      greet(); setupTabs();
      // Background: validate token and role before loading sensitive teacher data
      (async ()=>{
        try{
          const profile = await fetchServerProfile(token);
          if(!profile){
            localStorage.removeItem('auth_token'); localStorage.removeItem('auth_profile'); CURRENT_PROFILE = null;
            toast('err','Sesi tidak valid. Mengarahkan ke login...');
            setTimeout(()=> location.href='login.html?to='+encodeURIComponent('pengujian.html'),1200);
            return;
          }
          if((profile.role||'').toLowerCase() !== 'guru'){
            toast('err','Anda tidak memiliki akses ke halaman ini. Mengalihkan ke dashboard...');
            setTimeout(()=> location.href='dashboard.html',800);
            return;
          }
          // token valid and role ok → set authoritative profile and load data
          CURRENT_PROFILE = profile; try{ localStorage.setItem('auth_profile', JSON.stringify(profile)); }catch(_){}
          greet();
          loadPengujian();
        }catch(e){
          // network/server error: keep page in minimal state and notify user
          console.warn('Background validation failed', e && e.message);
          toast('err','Gagal memverifikasi sesi (jaringan). Silakan coba ulang.');
        }
      })();

      const mc=document.getElementById('modalCancel'); const mcf=document.getElementById('modalConfirm'); const modal=document.getElementById('confirmModal'); if(mc) mc.addEventListener('click', closeConfirm); if(mcf) mcf.addEventListener('click', performDelete); if(modal){ modal.addEventListener('click', (e)=>{ if(e.target===modal || e.target.classList.contains('bg-black/40')) closeConfirm(); }); }
      if(window.lucide && typeof window.lucide.createIcons === 'function'){ window.lucide.createIcons(); }
    }
    // Score modal logic
    function openScoreModal(username, nama, has){
      const modal = document.getElementById('scoreModal'); if(!modal) return;
      document.getElementById('scoreName').textContent = nama || '-';
      modal.setAttribute('data-username', username || '');
      // default values
      ['struktur','penyampaian','penguasaan','media','sikap'].forEach(k=>{ const el=document.getElementById('score-'+k); if(el) el.value='4'; });
      // if existing nilai, prefill
      if(has && String(has) === '1' && username && nilaiMapGlobal.has(username)){
        const n = nilaiMapGlobal.get(username);
        try{
          if(n.struktur) document.getElementById('score-struktur').value = String(n.struktur);
          if(n.penyampaian) document.getElementById('score-penyampaian').value = String(n.penyampaian);
          if(n.penguasaan) document.getElementById('score-penguasaan').value = String(n.penguasaan);
          if(n.media) document.getElementById('score-media').value = String(n.media);
          if(n.sikap) document.getElementById('score-sikap').value = String(n.sikap);
        }catch(e){}
        const saveBtn = document.getElementById('scoreSave'); if(saveBtn) saveBtn.textContent = 'Perbarui';
      } else {
        const saveBtn = document.getElementById('scoreSave'); if(saveBtn) saveBtn.textContent = 'Simpan';
      }
      computeScore();
      modal.classList.remove('hidden');
      if(window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
    }
    function closeScoreModal(){ const m=document.getElementById('scoreModal'); if(m) m.classList.add('hidden'); }
    function computeScore(){
      const weights = {struktur:20, penyampaian:20, penguasaan:20, media:20, sikap:20};
      const keys = Object.keys(weights);
      let sumWeighted = 0; let sumMax = 0;
      let totalRaw = 0;
      keys.forEach(k=>{
        const v = parseInt(document.getElementById('score-'+k).value || '0',10)||0;
        totalRaw += v;
        sumWeighted += v * weights[k];
        sumMax += 4 * weights[k];
      });
      const avg = (totalRaw / keys.length) || 0;
      const final = Math.round((sumWeighted / sumMax) * 100);
      document.getElementById('score-average').textContent = avg.toFixed(2);
      document.getElementById('score-final').textContent = final;
      return { avg, final };
    }
    // attach change handlers
    ['struktur','penyampaian','penguasaan','media','sikap'].forEach(k=>{ const el = document.getElementById('score-'+k); if(el) el.addEventListener('change', computeScore); });
    // save handler: submit to backend via iframe like other flows
    document.addEventListener('click', (ev)=>{
      if(ev.target && ev.target.id === 'scoreCancel') closeScoreModal();
      if(ev.target && ev.target.id === 'scoreSave'){
        const nama = document.getElementById('scoreName').textContent || '';
        const struktur = document.getElementById('score-struktur').value;
        const penyampaian = document.getElementById('score-penyampaian').value;
        const penguasaan = document.getElementById('score-penguasaan').value;
        const media = document.getElementById('score-media').value;
        const sikap = document.getElementById('score-sikap').value;
        const { final } = computeScore();
        // prepare form post to BASE
  const form = document.createElement('form'); form.method='post'; form.target='upload_iframe'; form.action=BASE;
        const add=(n,v)=>{ const i=document.createElement('input'); i.type='hidden'; i.name=n; i.value=v; form.appendChild(i); };
  // include username as key and also nama for readability
  const modal = document.getElementById('scoreModal'); const username = modal ? modal.getAttribute('data-username') : '';
  add('action','save_nilai'); add('username', username); add('nama', nama); add('struktur', struktur); add('penyampaian', penyampaian); add('penguasaan', penguasaan); add('media', media); add('sikap', sikap); add('total', final);
        document.body.appendChild(form);
        showLoading(true);
        form.submit(); form.remove();
  // we'll optimistically mark saved and close modal; server-side will update/insert
  closeScoreModal();
  toast('ok', 'Mengirim nilai...');
  // Poll the nilai dataset to confirm save (fallback in case postMessage doesn't arrive)
  (async ()=>{ await pollSaveConfirmation(username, final); })();
      }
    });
    if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }
  </script>

  <!-- FOOTER -->
  <footer class="border-t bg-white mt-6">
    <div class="mx-auto max-w-6xl px-4 py-8 text-xs text-slate-500 flex flex-wrap items-center justify-between gap-3">
      <div>&copy; <span id="year"></span> Sistem Informasi PKL & UKK Industri - TKJ SMKN 1 Telagasari</div>
      <nav class="flex gap-3" aria-label="Tautan footer">
        <a href="index.html" class="hover:underline">Home</a>
        <a href="pembimbing.html" class="hover:underline">Pembimbing</a>
        <a href="penguji.html" class="hover:underline">Penguji PKL</a>
        <a href="peserta.html" class="hover:underline">Peserta</a>
        <a href="ukk.html" class="hover:underline">UKK Industri</a>
      </nav>
    </div>
  </footer>
  <script>try{ var yEl=document.getElementById('year'); if(yEl){ yEl.textContent = new Date().getFullYear(); } }catch(e){}</script>
</body>
</html>
